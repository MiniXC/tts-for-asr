
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta property="og:title" content="A sample project: Zipf’s law" />
  
<meta property="og:type" content="website" />
  
<meta property="og:url" content="cdminix.me/archive/zipf.html" />
  
<meta property="og:description" content="Let’s look at how we can use the suggested organization in a real project. We use the example of calculating Zipf’s law for a series of English texts, which was suggested in the book Research Softw..." />
  
<meta property="og:image" content="https://goodresearch.dev/_images/unicorn.png" />
  
<meta property="og:image:alt" content="A sample project: Zipf’s law" />
  
    <title>A sample project: Zipf’s law &#8212; TTS for ASR</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
  <!-- add `style` or `link` tags with your CSS `@font-face` declarations here -->
  <!-- ... and optionally preload the `woff2` for snappier page loads -->
  <link rel="preload" href="../_static/et-book/et-book-bold-line-figures/et-book-bold-line-figures.woff" as="font" type="font/woff" crossorigin>
  <link rel="preload" href="../_static/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.woff" as="font" type="font/woff" crossorigin>
  <link rel="preload" href="../_static/et-book/et-book-roman-line-figures/et-book-roman-line-figures.woff" as="font" type="font/woff" crossorigin>
  <link rel="preload" href="../_static/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.woff" as="font" type="font/woff" crossorigin>
  <link rel="preload" href="../_static/et-book/et-book-semi-bold-old-style-figures/et-book-semi-bold-old-style-figures.woff" as="font" type="font/woff" crossorigin>

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.59e7d1499aa759519747cb2a1a335dc4.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tufte.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.90c857b2bf8f3d46aa488b0ed8bf60a6.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://cdminix.me/tts-for-asr/archive/zipf.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@patrickmineault" />
    <meta name="twitter:title" content="The Good Research Code Handbook" />
    <meta name="twitter:description" content="This handbook is for grad students, postdocs and PIs who do a lot of programming as part of their research. It will teach you, in a practical manner, how to organize your code so that it is easy to understand and works reliably." />
    <meta name="twitter:image" content="https://goodresearch.dev/_images/unicorn.png" />

    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3Q6LDVNS0X"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-3Q6LDVNS0X');
    </script>
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/one.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">TTS for ASR</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   TTS for Low-Resource ASR
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Fundmentals
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/other_fields.html">
   Synthetic Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/low_resource_asr.html">
   Low-Resource ASR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/tts.html">
   TTS
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  TTS for Low-Resource
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/cross_speaker.html">
   Cross-Speaker Transfer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/cross_lingual.html">
   Cross-Lingual Transfer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/speechchain.html">
   Speech Chain / Backtransformation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Combining ASR &amp; TTS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/augmentation.html">
   Augmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/transfer.html">
   Domain Transfer
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  My Work
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/fastspeech2.html">
   FastSpeech 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/conditioning.html">
   Conditioning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/snr.html">
   SNR Variance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/german-to-english.html">
   German-to-English Transfer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/future.html">
   Future Work
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/references.html">
   References
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

<nav class="bd-links" id="nav-social">
    <div class="bd-toc-item">
        <p class="caption">
            <span class="caption-text">Social</span>
        </p>
        <ul class="nav bd-sidenav" style="display:block">
            <li class="toctree-l1"><a class="github-button" href="https://github.com/patrickmineault/codebook" data-icon="octicon-star" data-show-count="true" data-size="large" aria-label="Star patrickmineault/codebook on GitHub">Star on Github</a></li>
            <li class="toctree-l1"><a href="http://eepurl.com/hHgNOH">Subscribe for updates</a></li>
            <li class="toctree-l1"><a href="http://twitter.com/share?text=The+Good+Research+Code+Handbook.+Learn+to+write+readable%2C+maintainable+research+code+in+Python.&url=https://goodresearch.dev&user&via=patrickmineault" class="twitter-share-button" data-text="The Good Research Code Handbook. Learn to write readable, maintainable code in Python." data-via="patrickmineault" data-show-count="false">Tweet this handbook</a></li>
        </ul>
    </div>
</nav>
</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/archive/zipf.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/cdminix/tts-for-asr"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/cdminix/tts-for-asr/issues/new?title=Issue%20on%20page%20%2Farchive/zipf.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/cdminix/tts-for-asr/edit/main/./archive/zipf.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-is-zipf-s-law-anyway">
   What is Zipf’s law, anyway?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#our-project">
   Our project
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#download-the-texts">
   Download the texts
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#count-the-words">
   Count the words
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calculate-zipf-s-law">
   Calculate Zipf’s law
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#write-the-command-line-interface">
   Write the command line interface
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#make-summary-figures">
   Make summary figures
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-did-we-learn">
   What did we learn?
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="a-sample-project-zipf-s-law">
<h1>A sample project: Zipf’s law<a class="headerlink" href="#a-sample-project-zipf-s-law" title="Permalink to this headline">¶</a></h1>
<p>Let’s look at how we can use the suggested organization in a real project. We use the example of calculating Zipf’s law for a series of English texts, which was suggested in the book <a class="reference external" href="https://merely-useful.tech/py-rse/">Research Software Engineering in Python</a>, and was released under a CC-BY license. <a class="reference external" href="https://github.com/patrickmineault/zipf/">You can see the completed project on Github</a>.</p>
<div class="section" id="what-is-zipf-s-law-anyway">
<h2>What is Zipf’s law, anyway?<a class="headerlink" href="#what-is-zipf-s-law-anyway" title="Permalink to this headline">¶</a></h2>
<p>Zipf’s law comes from quantitative linguistics. It states the most used word in a language is used twice as much as the second most used word, three times as much of the third, etc. It’s an empirical law that holds in different languages and texts. There’s a lot of interesting theories about why it should hold - <a class="reference external" href="https://en.wikipedia.org/wiki/Zipf%27s_law">have a look at the Wikipedia article if you’re curious</a>. A generalized form of Zipf’s law states that:</p>
<div class="math notranslate nohighlight">
\[p(r) = \frac{1}{Cr^\alpha}\]</div>
<p>That is, the frequency of <span class="math notranslate nohighlight">\(r^{th}\)</span> most frequent word in a language is a power law with exponent <span class="math notranslate nohighlight">\(\alpha\)</span>; the canonical Zipf’s law is obtained when <span class="math notranslate nohighlight">\(\alpha=1\)</span>. <span class="math notranslate nohighlight">\(C\)</span> is a constant that makes the distribution add up to 1.</p>
</div>
<div class="section" id="our-project">
<h2>Our project<a class="headerlink" href="#our-project" title="Permalink to this headline">¶</a></h2>
<p>The goal of the project is to measure that Zipf’s law holds in three freely available texts. We’ll proceed as follows:</p>
<ol class="simple">
<li><p>download some texts from project Gutenberg</p></li>
<li><p>compute the distribution of words</p></li>
<li><p>fit Zipf’s law to each of them</p></li>
<li><p>output metrics</p></li>
<li><p>plot some diagnostics</p></li>
</ol>
<p>Let’s consider different ways to organize the different subcomponents and define how they should interact with each other. It’s clear that the processing has the nice structure of a (linear) directed acyclic graph (DAG).</p>
<div class="boxed figure align-default" id="id1">
<img alt="archive/figures/zipf-diagram.svg" src="archive/figures/zipf-diagram.svg" /><p class="caption"><span class="caption-text">The Zipf project can be described as a linear directed acyclic graph (DAG)</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p><em>Approach 1</em>. We could make each box a separate script with command line arguments. Each script would be backed with module code that would help in a common library. Then, we would glue these scripts together with a bash file, or perhaps with make. This approach has a lot of merit, and in fact was the one that was originally suggested by the book: it’s clean and it’s standardized. One inconvenience is that it involves writing a lot of repetitive code in order to define command line interfaces. There’s also a bit of overhead in writing both a script and module code for each subcomponent.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>The amount of cruft for command line interfaces could be reduced significantly using the <a class="reference external" href="https://palletsprojects.com/p/click/"><code class="docutils literal notranslate"><span class="pre">click</span></code></a> library.</p>
</div>
<p><em>Approach 2</em>. We could make each box a separate function, held in a module. Then, we would glue these functions together with a Python script. This Python script would have its own command line arguments, which we could set in a bash script. One merit of the approach is that it has less overhead - fewer files and cruft - than the first approach.</p>
<p>The tradeoff between these two approaches lies in the balance between generality and complexity. The first is a bit more flexible than the second. We can’t run a single component of our analysis separately from the command line - we’ll need to implement tests instead, which feel a little less intuitive. If we wanted to run an analysis of tens of thousands of books, parallelizing would also be easier with the first approach (e.g. <a class="reference external" href="https://www.gnu.org/software/make/manual/html_node/Parallel.html">with <code class="docutils literal notranslate"><span class="pre">make</span></code></a>).</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Different people - and sometimes the same person at different points in time - can disagree on the very best approach for a particular problem. In the end, what matters more is that the process through which the code was deliberate. If you put some thought into the organization - you’re 90% of the way there.</p>
</div>
<p>For this example, however, I have a slight preference for the second approach, so that’s the one we will implement. Keeping the number of command line tools to create to one means we’ll worry less about cruft and more about the computations. Let’s take a look at the DAG again to see how we’ll split the job:</p>
<div class="boxed figure align-default" id="id2">
<img alt="archive/figures/zipf-diagram-coded.svg" src="archive/figures/zipf-diagram-coded.svg" /><p class="caption"><span class="caption-text">The Zipf project split into different sub-components.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>We’ll create one module to compute the distribution of words, and another to fit Zipf’s law. We will create tests for each of those two modules. We’ll wrap the two modules as well as glue code inside a command line tool. Plotting will take place in jupyter notebook, which makes it easy to change plots interactively.</p>
<p>I encourage you to also have a look at the Python RSE github repo for an alternative implementation to examine the tradeoffs in different implementations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Most of the code is taken verbatim from the <a class="reference external" href="https://github.com/merely-useful/py-rse/tree/book/zipf">Py-RSE repo</a>. Our emphasis here is on organizing project files.</p>
</div>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>Let’s proceed with setting up the project. <code class="docutils literal notranslate"><span class="pre">zipf</span></code> is a reasonable project name, so let’s go ahead and create a new project with that name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(base) ~/Documents $ cookiecutter gh:patrickmineault/true-neutral-cookiecutter
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">zipf</span></code>, <code class="docutils literal notranslate"><span class="pre">zipf</span></code>, and <code class="docutils literal notranslate"><span class="pre">zipf</span></code> as the answers to the first 3 questions, and “Zipf’s law project” as the description. Then proceed to create an environment and save it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> zipf
conda create --name zipf <span class="nv">python</span><span class="o">=</span><span class="m">3</span>.8
conda activate zipf
conda env <span class="nb">export</span> &gt; environment.yml
</pre></div>
</div>
<p>Then we can sync to a Github remote. My favorite way of doing this is to use the GUI in vscode, which saves me from going to Github to create the remote <em>and</em> then type on the command line to sync locally. We can fire up vscode using:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">code .</span>
</pre></div>
</div>
<p>Then, in the git panel, we hit “Publish to Github” to locally set up git and create the Github remote in one shot.</p>
<p>Now we have a good looking project skeleton! We can set up <code class="docutils literal notranslate"><span class="pre">black</span></code> in vscode so that whenever a file is saved, it is formatted in a standard way. Time to add some code to it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you prefer, you can instead go through github.com to create a new repo and follow the command line instructions there.</p>
</div>
</div>
<div class="section" id="download-the-texts">
<h2>Download the texts<a class="headerlink" href="#download-the-texts" title="Permalink to this headline">¶</a></h2>
<p>We want to download three texts and put them in the <code class="docutils literal notranslate"><span class="pre">data</span></code> folder. Ideally, we’d do this automatically, for example with a bash file with calls to <code class="docutils literal notranslate"><span class="pre">wget</span></code>. However, the terms and conditions from Project Gutenberg state:</p>
<blockquote class="epigraph">
<div><p>The website is intended for human users only. Any perceived use of automated tools to access the Project Gutenberg website will result in a temporary or permanent block of your IP address.The website is intended for human users only. Any perceived use of automated tools to access the Project Gutenberg website will result in a temporary or permanent block of your IP address.
–<a class="reference external" href="https://www.gutenberg.org/policy/robot_access.html">Project Gutenberg</a></p>
</div></blockquote>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Document manual steps in README.md!</p>
</div>
<p>Not a big deal! We can download the files manually and document the source in the <code class="docutils literal notranslate"><span class="pre">README.md</span></code> file. Let’s download the following files manually and put them in the data folder:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.gutenberg.org/files/345/345-0.txt">Dracula</a> → <code class="docutils literal notranslate"><span class="pre">data/dracula.txt</span></code></p></li>
<li><p><a class="reference external" href="https://www.gutenberg.org/ebooks/42324.txt.utf-8">Frankenstein</a> → <code class="docutils literal notranslate"><span class="pre">data/frankenstein.txt</span></code></p></li>
<li><p><a class="reference external" href="https://www.gutenberg.org/files/1260/1260-0.txt">Jane Eyre</a> → <code class="docutils literal notranslate"><span class="pre">data/jane_eyre.txt</span></code></p></li>
</ul>
</div>
<div class="section" id="count-the-words">
<h2>Count the words<a class="headerlink" href="#count-the-words" title="Permalink to this headline">¶</a></h2>
<p>The next step is to calculate word counts for each text. We will create a module called <code class="docutils literal notranslate"><span class="pre">parse_text</span></code> in the <code class="docutils literal notranslate"><span class="pre">zipf</span></code> folder. It will contain a function <code class="docutils literal notranslate"><span class="pre">count_words</span></code> that takes in a text string and outputs a set of counts. This function will itself call a helper function <code class="docutils literal notranslate"><span class="pre">_clean_gutenberg_text</span></code>. Note that the function starts with an underscore to indicate that it is meant to be a private function used internally by the module.</p>
<p><code class="docutils literal notranslate"><span class="pre">_clean_gutenberg_text</span></code> will explicitly filter out boilerplate from project Gutenberg texts. There’s a significant amount of boilerplate at the start of e-books and license information at the end, which might skew the word count distribution. Thankfully, there are phrases in the e-books which delimit the main text, which we can detect:</p>
<ul class="simple">
<li><p>START OF THE PROJECT GUTENBERG EBOOK</p></li>
<li><p>END OF THE PROJECT GUTENBERG EBOOK</p></li>
</ul>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p><a class="reference external" href="https://blog.ldodds.com/2020/01/31/do-data-scientists-spend-80-of-their-time-cleaning-data-turns-out-no/">Ensuring data quality is huge chunk of the workload of data scientists</a>.</p>
</div>
<p>Because we only have three books in our collection, we can manually test that each book is processed correctly. However, if we ever process a fourth, unusually formatted text, and our detection didn’t work, we want our pipeline to fail in a graceful way. Thus, we add in-line <code class="docutils literal notranslate"><span class="pre">assert</span></code> statements to make sure our filter finds the two delimiters in reasonable locations in the text.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_clean_gutenberg_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find fences in a Gutenberg text and select the text between them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_fence</span> <span class="o">=</span> <span class="s2">&quot;start of the project gutenberg ebook&quot;</span>
    <span class="n">end_fence</span> <span class="o">=</span> <span class="s2">&quot;end of the project gutenberg ebook&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">start_pos</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">start_fence</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_fence</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">end_pos</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">end_fence</span><span class="p">)</span>

    <span class="c1"># Check that the fences are at reasonable positions within the text.</span>
    <span class="k">assert</span> <span class="mf">0.000001</span> <span class="o">&lt;</span> <span class="n">start_pos</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.1</span>
    <span class="k">assert</span> <span class="mf">0.9</span> <span class="o">&lt;</span> <span class="n">end_pos</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>

    <span class="k">return</span> <span class="n">text</span><span class="p">[</span><span class="n">start_pos</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span>
</pre></div>
</div>
<p>Now we can use call this function in another wrapper function that counts words ike so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">collections</span>


<span class="k">def</span> <span class="nf">count_words</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">clean_text</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Count words in a file.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        f: an open file handle</span>
<span class="sd">        clean_text (optional): a Boolean, if true, filters out boilerplate typical of a Gutenberg book.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dict keyed by word, with word counts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">clean_text</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">_clean_gutenberg_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="n">chunks</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">npunc</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">]</span>
    <span class="n">word_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">npunc</span> <span class="k">if</span> <span class="n">word</span><span class="p">]</span>
    <span class="n">word_counts</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">word_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">word_counts</span><span class="p">)</span>
</pre></div>
</div>
<p>To test that the <code class="docutils literal notranslate"><span class="pre">count_words</span></code> function works as intended, we make a sample txt file in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> folder which contains dummy data:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>The

*** START OF THE PROJECT GUTENBERG EBOOK ***
OF
TO to
I i i
and and and and
THE The     THE the thE
[...]
*** END OF THE PROJECT GUTENBERG EBOOK ***


OF
</pre></div>
</div>
<p>If our function works correctly, it should ignore all the text outside of the start and end fences. It should return:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;the&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>We set up a test function in <code class="docutils literal notranslate"><span class="pre">test_parse_text.py</span></code> that loads this test text and verifies that the word counts are correctly measured. The test can be run with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pytest tests/test_parse_text.py
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/patrickmineault/zipf/blob/master/zipf/parse_text.py">The resulting module</a> and <a class="reference external" href="https://github.com/patrickmineault/zipf/blob/master/tests/test_parse_text.py">test</a> can be viewed on Github.</p>
</div>
<div class="section" id="calculate-zipf-s-law">
<h2>Calculate Zipf’s law<a class="headerlink" href="#calculate-zipf-s-law" title="Permalink to this headline">¶</a></h2>
<p>Once we have word counts, we can calculate Zipf’s law based on word counts. We use the method proposed in <a class="reference external" href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0147073#sec004">Moreno-Sanchez et al. (2016)</a>, which is implemented in the book Research Software Engineering with Python. The method calculates the maximum likelihood <span class="math notranslate nohighlight">\(\alpha\)</span> parameter for the empirical distribution of ranks. It starts with <span class="math notranslate nohighlight">\(\alpha = 1\)</span> and refines the estimate through gradient descent. We implement this method in <a class="reference external" href="https://github.com/patrickmineault/zipf/blob/master/zipf/fit_distribution.py"><code class="docutils literal notranslate"><span class="pre">fit_distribution.py</span></code></a>.</p>
<p>It’s quite easy to make a mistake in calculating the exponent by incorrectly implementing the error function. To protect ourselves against this, in our test suite, we generate data from a known distribution with <span class="math notranslate nohighlight">\(\alpha = 1\)</span> and verify that the correct exponent is estimated. We put this test, <a class="reference external" href="https://github.com/patrickmineault/zipf/blob/master/tests/test_fit_distribution.py"><code class="docutils literal notranslate"><span class="pre">test_fit_distribution.py</span></code></a> under the tests folder.</p>
</div>
<div class="section" id="write-the-command-line-interface">
<h2>Write the command line interface<a class="headerlink" href="#write-the-command-line-interface" title="Permalink to this headline">¶</a></h2>
<p>We are now ready to write glue code to run our pipeline from the command line. We create a script, <code class="docutils literal notranslate"><span class="pre">run_analysis.py</span></code>, under the scripts folder. Our script takes in two different command line arguments, or flags:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">in_folder</span></code>: the input folder containing txt files.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">out_folder</span></code>: where we will output the results</p></li>
</ul>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Keep your command line programs to less than 20 flags. Beyond that, they become a pain to maintain.</p>
</div>
<p>We create this command line interface using <code class="docutils literal notranslate"><span class="pre">argparse</span></code>. This looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Compute zipf distribution&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--in_folder&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the input folder&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--out_folder&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;the output folder&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">main</span></code> function first verifies that there are files to be processed and creates the output folder if necessary. To manipulate paths, it uses the <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> module. The function then runs each of the stages of the pipeline in turn until completion. We don’t write tests this part of the code, as we’ve lifted the error-prone aspects of the code elsewhere. Again, the goal is rarely to get 100% coverage, but rather to have good coverage where it counts.</p>
<p>The code uses a for loop to construct a table of results, which is then loaded into pandas, and then dumped to disk as csv. Pandas is not strictly necessary to write a csv file, but it’s the default choice to work with tabular data in Python, so it is used here. <a class="reference external" href="https://github.com/patrickmineault/zipf/blob/master/scripts/run_analysis.py">Have a look at the script here</a>.</p>
</div>
<div class="section" id="make-summary-figures">
<h2>Make summary figures<a class="headerlink" href="#make-summary-figures" title="Permalink to this headline">¶</a></h2>
<p>Finally, to generate figures, we prefer the jupyter notebook environment. Polishing figures takes some trial and error, and the jupyter notebook environment makes it easy to iterate on figures. The notebook, in <code class="docutils literal notranslate"><span class="pre">scripts/visualize_results.ipynb</span></code>, takes in results files as csvs, and generates figures and summary tables from them.</p>
<div class="boxed figure align-default" id="id3">
<img alt="archive/figures/oneoverf.png" src="archive/figures/oneoverf.png" />
<p class="caption"><span class="caption-text">A plot generated by our pipeline. Zipf distribution estimated on the movel Frankenstein by Mary Shelley.</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>We used the standard choice of matplotlib for the figures, although with the stylesheet from seaborn, which is more aesthetically pleasing. Note, however, that there are a number of excellent libraries for interactive graphics, so if this was critical, we could certainly apply this here. There is no computation in the notebook, only figure and summary table generation, which keeps the code in the notebook to a minimum.</p>
</div>
<div class="section" id="what-did-we-learn">
<h2>What did we learn?<a class="headerlink" href="#what-did-we-learn" title="Permalink to this headline">¶</a></h2>
<p>We saw how to organize an analysis according to the organization proposed in this handbook. We created a new project folder and module with the true neutral cookiecutter. If this analysis were part of a larger project - a paper or book chapter - we would re-use the same project folder, and add new pipelines and analyses to the project.</p>
<p>When I started this project, I was surprised by how many macro- and micro-decisions were needed to be made about how a pipeline works and how it’s organized. A little bit of thinking ahead can avoid days of headaches later on. In this case, we chose a lightweight structure with one entry script calling module functions. These module functions are short and most of them are pure functions. Pure functions are easier to test. Indeed, we wrote unit tests to check that these functions worked as intended. That way, once the code was written and tests passed, it was crystal clear that the code worked as intended. We separated module code from glue code and plotting code. The resulting code is decoupled and easily maintainable.</p>
<p>Writing code in this organized way is effortful. Over the long term, this methodical approach is more efficient, and more importantly, it’s less stressful.</p>
<div class="admonition-minute-exercise admonition">
<p class="admonition-title">5-minute exercise</p>
<p>How would you change this pipeline so that it computes error bars for the parameters of the Zipf distribution through bootstrapping? Would you need to change existing functions? What function would you need to add? <em>If you’re feeling adventurous, go ahead and implement it! It’s definitely more than a 5-minute project!</em></p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "cdminix/tts-for-asr",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./archive"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By <a href='https://cdminix.me'>Christoph Minixhofer</a> <a href='https://twitter.com/cdminix'><img height='24' width='24' src='_images/twitter.svg' alt='Twitter' style='width:24px'></a><br/>
        
            &copy; Copyright 2021.<br/>
          <div class="extra_footer">
            Licensed under CC-BY 4.0, Template based on <a href='goodresearch.dev'>goodresearch.dev</a>.
          </div>
      </p>
    </div>
  </footer>
  <!-- Place this tag in your head or just before your close body tag. -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>