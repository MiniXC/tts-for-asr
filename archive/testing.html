
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta property="og:title" content="Test your code" />
  
<meta property="og:type" content="website" />
  
<meta property="og:url" content="cdminix.me/archive/testing.html" />
  
<meta property="og:description" content="Most scientists who write software constantly test their code. That is, if you are a scientist writing software, I am sure that you have tried to see how well your code works by running every new f..." />
  
<meta property="og:image" content="https://goodresearch.dev/_images/unicorn.png" />
  
<meta property="og:image:alt" content="Test your code" />
  
    <title>Test your code &#8212; TTS for ASR</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
  <!-- add `style` or `link` tags with your CSS `@font-face` declarations here -->
  <!-- ... and optionally preload the `woff2` for snappier page loads -->
  <link rel="preload" href="../_static/et-book/et-book-bold-line-figures/et-book-bold-line-figures.woff" as="font" type="font/woff" crossorigin>
  <link rel="preload" href="../_static/et-book/et-book-display-italic-old-style-figures/et-book-display-italic-old-style-figures.woff" as="font" type="font/woff" crossorigin>
  <link rel="preload" href="../_static/et-book/et-book-roman-line-figures/et-book-roman-line-figures.woff" as="font" type="font/woff" crossorigin>
  <link rel="preload" href="../_static/et-book/et-book-roman-old-style-figures/et-book-roman-old-style-figures.woff" as="font" type="font/woff" crossorigin>
  <link rel="preload" href="../_static/et-book/et-book-semi-bold-old-style-figures/et-book-semi-bold-old-style-figures.woff" as="font" type="font/woff" crossorigin>

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.59e7d1499aa759519747cb2a1a335dc4.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tufte.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.90c857b2bf8f3d46aa488b0ed8bf60a6.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://cdminix.me/tts-for-asr/archive/testing.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@patrickmineault" />
    <meta name="twitter:title" content="The Good Research Code Handbook" />
    <meta name="twitter:description" content="This handbook is for grad students, postdocs and PIs who do a lot of programming as part of their research. It will teach you, in a practical manner, how to organize your code so that it is easy to understand and works reliably." />
    <meta name="twitter:image" content="https://goodresearch.dev/_images/unicorn.png" />

    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3Q6LDVNS0X"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-3Q6LDVNS0X');
    </script>
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/one.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">TTS for ASR</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   TTS for Low-Resource ASR
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Fundmentals
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/other_fields.html">
   Synthetic Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/low_resource_asr.html">
   Low-Resource ASR
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/tts.html">
   TTS
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  TTS for Low-Resource
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/cross_speaker.html">
   Cross-Speaker Transfer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/cross_lingual.html">
   Cross-Lingual Transfer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/speechchain.html">
   Speech Chain / Backtransformation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Combining ASR &amp; TTS
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/augmentation.html">
   Data Augmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/transfer.html">
   Knowledge Transfer
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  My Work
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/fastspeech2.html">
   FastSpeech 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/conditioning.html">
   Conditioning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/snr.html">
   SNR Variance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/german-to-english.html">
   German-to-English Transfer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/future.html">
   Future Work
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  References
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown/references.html">
   References
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

<nav class="bd-links" id="nav-social">
    <div class="bd-toc-item">
        <p class="caption">
            <span class="caption-text">Social</span>
        </p>
        <ul class="nav bd-sidenav" style="display:block">
            <li class="toctree-l1"><a class="github-button" href="https://github.com/patrickmineault/codebook" data-icon="octicon-star" data-show-count="true" data-size="large" aria-label="Star patrickmineault/codebook on GitHub">Star on Github</a></li>
            <li class="toctree-l1"><a href="http://eepurl.com/hHgNOH">Subscribe for updates</a></li>
            <li class="toctree-l1"><a href="http://twitter.com/share?text=The+Good+Research+Code+Handbook.+Learn+to+write+readable%2C+maintainable+research+code+in+Python.&url=https://goodresearch.dev&user&via=patrickmineault" class="twitter-share-button" data-text="The Good Research Code Handbook. Learn to write readable, maintainable code in Python." data-via="patrickmineault" data-show-count="false">Tweet this handbook</a></li>
        </ul>
    </div>
</nav>
</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/archive/testing.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/archive/testing.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/cdminix/tts-for-asr"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/cdminix/tts-for-asr/issues/new?title=Issue%20on%20page%20%2Farchive/testing.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/cdminix/tts-for-asr/edit/main/./archive/testing.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/cdminix/tts-for-asr/main?urlpath=tree/./archive/testing.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-to-maintain-your-sanity">
   Testing to maintain your sanity
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#unit-testing-by-example">
   Unit testing by example
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#lightweight-formal-tests-with-assert">
     Lightweight formal tests with
     <code class="docutils literal notranslate">
      <span class="pre">
       assert
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#refactoring-with-confidence-with-tests">
     Refactoring with confidence with tests
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#testing-pure-functions">
     Testing pure functions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#testing-with-a-test-suite">
     Testing with a test suite
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-non-pure-functions-and-classes">
   Testing non-pure functions and classes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-hierarchy-of-tests">
   A hierarchy of tests
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#write-lots-of-tiny-unit-tests">
   Write lots of tiny unit tests
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#now-you-re-playing-with-power">
   Now you’re playing with power
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#discussion">
   Discussion
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="test-your-code">
<span id="test"></span><h1>Test your code<a class="headerlink" href="#test-your-code" title="Permalink to this headline">¶</a></h1>
<blockquote class="epigraph">
<div><p>Most scientists who write software constantly test their code. That is, if you are a scientist writing software, I am sure that you have tried to see how well your code works by running every new function you write, examining the inputs and the outputs of the function, to see if the code runs properly (without error), and to see whether the results make sense. Automated code testing takes this informal practice, makes it formal, and automates it, so that you can make sure that your code does what it is supposed to do, even as you go about making changes around it.</p>
<p class="attribution">—<a class="reference external" href="https://github.com/uwescience/shablona">Ariel Rokem</a></p>
</div></blockquote>
<p>Automated testing is one of the most powerful techniques that professional programmers use to make code robust. Having never used testing until I went to industry, it changed the way I write code for the better.</p>
<div class="section" id="testing-to-maintain-your-sanity">
<h2>Testing to maintain your sanity<a class="headerlink" href="#testing-to-maintain-your-sanity" title="Permalink to this headline">¶</a></h2>
<p>When you run an experiment and the results of the analysis don’t make sense, you will go through a process of eliminating one potential cause after the other. You will investigate several hypotheses, including:</p>
<ul class="simple">
<li><p>the data is bad</p></li>
<li><p>you’re loading the data incorrectly</p></li>
<li><p>your model is incorrectly implemented</p></li>
<li><p>your model is inappropriate for the data</p></li>
<li><p>the statistical test you used is inappropriate for the data distribution</p></li>
</ul>
<p>Testing can help you maintain your sanity by decreasing the surface of things that might be wrong with your experiment. Good code yells loudly when something goes wrong. Imagine that you had an experimental setup that alerted you when you had a ground loop, or that would sound off when you use the wrong reagent, or that would text you when it’s about to overheat - how many hours or days would you save?</p>
</div>
<div class="section" id="unit-testing-by-example">
<h2>Unit testing by example<a class="headerlink" href="#unit-testing-by-example" title="Permalink to this headline">¶</a></h2>
<p>Unit testing is the practice of testing a <em>unit</em> of code, typically a single function. The easiest way to understand what that means is to illustrate it with a specific example. The Fibonacci sequence is defined as:</p>
<div class="math notranslate nohighlight">
\[F(x) \equiv F(x-1) + F(x-2)\]</div>
<div class="math notranslate nohighlight">
\[F(0) \equiv 0 \]</div>
<div class="math notranslate nohighlight">
\[F(1) \equiv 1 \]</div>
<p><a class="reference external" href="https://oeis.org/A000045">The first few items in the Fibonacci sequence</a> are:</p>
<div class="math notranslate nohighlight">
\[F = 0, 1, 1, 2, 3, 5, 8, 13, 21, \ldots\]</div>
<p>Let’s write up a naive implementation of this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s say that a colleague brings you this code and asks you to check that the code they’ve written up works. How would check whether this code works?</p>
<details class="sphinx-bs dropdown card mb-3">
<summary class="summary-title card-header">
⚠️ Spoilers<div class="summary-down docutils">
<svg version="1.1" width="24" height="24" class="octicon octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="summary-up docutils">
<svg version="1.1" width="24" height="24" class="octicon octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="summary-content card-body docutils">
<p class="card-text">You could run this code on the command line with different inputs and check that the code works as expected. For instance, you expect that:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fib</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="go">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fib</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fib</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fib</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="go">8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fib</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
<span class="go">102334155</span>
</pre></div>
</div>
<p class="card-text">You could also run the code with bad inputs, to check whether the code returns meaningful errors. For example, the sequence is undefined for negative numbers or non-integers.</p>
</div>
</details><p>Informal testing can be done in an interactive computing environment, like the <code class="docutils literal notranslate"><span class="pre">ipython</span></code> REPL or a jupyter notebook. Run the code, check the output, repeat until the code works right – it’s a workflow you’ve probably used as well.</p>
<div class="section" id="lightweight-formal-tests-with-assert">
<h3>Lightweight formal tests with <code class="docutils literal notranslate"><span class="pre">assert</span></code><a class="headerlink" href="#lightweight-formal-tests-with-assert" title="Permalink to this headline">¶</a></h3>
<p>One issue with informal tests is that they often have a short shelf life. Once the code is written and informal testing is over, you don’t have a record of that testing - you might even discard the tests you wrote in jupyter! We can make our tests stick with <code class="docutils literal notranslate"><span class="pre">assert</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">assert</span></code> is a special statement in Python that throws an error whenever the statement is false. For instance,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<span class="gr">AssertionError</span>
</pre></div>
</div>
<p>Notice that there are no parentheses between <code class="docutils literal notranslate"><span class="pre">assert</span></code> and the statement. <code class="docutils literal notranslate"><span class="pre">assert</span></code> is great for inline tests, for example checking whether the shape or a matrix is as expected after permuting its indices.</p>
<p>We can also assemble multiple assert operations to create a lightweight test suite. You can hide your asserts behind an <code class="docutils literal notranslate"><span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></code> statement, so that they will only run when you directly run a file. Let’s write some tests in <code class="docutils literal notranslate"><span class="pre">fib.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">102334155</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tests passed&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can run the tests from the command line:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python fib.py
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;fib.py&quot;, line 8, in &lt;module&gt;</span>
<span class="go">    assert fib(0) == 0</span>
<span class="go">AssertionError</span>
</pre></div>
</div>
<p>We see our test suite fail immediately for <code class="docutils literal notranslate"><span class="pre">fib(0)</span></code>. We can fix up the boundary conditions of the code, and run the code again. We repeat this process until all our tests pass. Let’s look at the fixed up code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">102334155</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tests passed&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>While the first few tests pass, the last one hangs for a long time. What’s going on here?</p>
</div>
<div class="section" id="refactoring-with-confidence-with-tests">
<h3>Refactoring with confidence with tests<a class="headerlink" href="#refactoring-with-confidence-with-tests" title="Permalink to this headline">¶</a></h3>
<p>Our <code class="docutils literal notranslate"><span class="pre">fib(N)</span></code> function hangs for a large value of <code class="docutils literal notranslate"><span class="pre">N</span></code> because it spawns a lot of repeated computation. <code class="docutils literal notranslate"><span class="pre">fib(N)</span></code> calls both <code class="docutils literal notranslate"><span class="pre">fib(N-1)</span></code> and <code class="docutils literal notranslate"><span class="pre">fib(N-2)</span></code>. In turn, <code class="docutils literal notranslate"><span class="pre">fib(N-1)</span></code> calls <code class="docutils literal notranslate"><span class="pre">fib</span></code> twice, and so on and so forth. Therefore, the time complexity of this function scales exponentially with <span class="math notranslate nohighlight">\(2^N\)</span> - it’s very slow.</p>
<p>We can re-implement this function so that it keeps a record of previously computed values. One straightforward way of doing this is with a global cache. <strong>We keep our previously implemented tests</strong>, and rewrite the function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">cache</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cache</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">val</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">102334155</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tests passed&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Running this new and improved script, we see:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python fib.py
<span class="go">Tests passed</span>
</pre></div>
</div>
<p>Hurray! We can be confident that our code works as expected. What if we want to refactor our code so that it doesn’t use globals? Not a problem, we keep the tests around, and we rewrite the code to use an inner function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">fib_inner</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">cache</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">fib_inner</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib_inner</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">return</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">fib_inner</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">102334155</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tests passed&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Running the module again, our tests still pass! Testing helps us refactor with confidence because we can immediately tell whether we’ve introduced new bugs in our code.</p>
</div>
<div class="section" id="testing-pure-functions">
<h3>Testing pure functions<a class="headerlink" href="#testing-pure-functions" title="Permalink to this headline">¶</a></h3>
<p>With pure functions, such as <code class="docutils literal notranslate"><span class="pre">fib</span></code>, we can readily come up with ways to test whether the code works or not. We can check:</p>
<ul class="simple">
<li><p><em>Correctness for typical inputs</em>, e.g. <span class="math notranslate nohighlight">\(F(5) = 5\)</span></p></li>
<li><p><em>Edge cases</em>, e.g. <span class="math notranslate nohighlight">\(F(0) = 0\)</span></p></li>
<li><p><em>Errors</em> with bad input, e.g. <span class="math notranslate nohighlight">\(F(-1)\)</span> → <em>error</em></p></li>
<li><p><em>Functional goals are achieved</em>, e.g. that the function works for large numbers</p></li>
</ul>
<p>Pure functions don’t require elaborate setups to test properly, and indeed they have some of the highest <em>bang for your buck</em> when it comes to testing. If in your current workflow, you would have manually checked whether a procedure yielded reasonable results, write a test for it.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If something caused a bug, write a test for it. 70% of bugs are old bugs that keep reappearing.</p>
</div>
</div>
<div class="section" id="testing-with-a-test-suite">
<h3>Testing with a test suite<a class="headerlink" href="#testing-with-a-test-suite" title="Permalink to this headline">¶</a></h3>
<p>Testing with <code class="docutils literal notranslate"><span class="pre">assert</span></code> hidden behind <code class="docutils literal notranslate"><span class="pre">__name__</span> <span class="pre">==</span> <span class="pre">'__main__'</span></code> works great for small-scale testing. However, once you have a lot of tests, it starts to make sense to group them into a <em>test suite</em> and run them with a <em>test runner</em>. There are two main frameworks to run unit tests in Python, <code class="docutils literal notranslate"><span class="pre">pytest</span></code> and <code class="docutils literal notranslate"><span class="pre">unittest</span></code>. <code class="docutils literal notranslate"><span class="pre">pytest</span></code> is the more popular of the two, so I’ll cover that here.</p>
<p>To install pytest on your system, first run:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">pytest</span>
</pre></div>
</div>
<p>Writing a test suite for pytest is a matter of taking our previous unit tests and putting them in a separate file, wrapping them in functions which start with <code class="docutils literal notranslate"><span class="pre">test_</span></code>. In <code class="docutils literal notranslate"><span class="pre">tests/test_fib.py</span></code>, we write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">src.fib</span> <span class="kn">import</span> <span class="n">fib</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">def</span> <span class="nf">test_typical</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">102334155</span>

<span class="k">def</span> <span class="nf">test_edge_case</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">fib</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">test_raises</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">):</span>
        <span class="n">fib</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">):</span>
        <span class="n">fib</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice that pytest primarily relies on the <code class="docutils literal notranslate"><span class="pre">assert</span></code> statement to do the heavy lifting. <code class="docutils literal notranslate"><span class="pre">pytest</span></code> also offers extra functionality to deal with special test cases. <code class="docutils literal notranslate"><span class="pre">pytest.raises</span></code> creates a context manager to verify that a function raises an expected exception.</p>
<p>Running the <code class="docutils literal notranslate"><span class="pre">pytest</span></code> utility from the command line, we find:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pytest test_fib.py
<span class="go">...</span>
<span class="go">    def fib_inner(x):</span>
<span class="go">        nonlocal cache</span>
<span class="go">        if x in cache:</span>
<span class="go">            return cache[x]</span>
<span class="go">&gt;       if x == 0:</span>
<span class="go">E       RecursionError: maximum recursion depth exceeded in comparison</span>

<span class="go">../src/fib.py:7: RecursionError</span>
<span class="go">============================= short test summary info =============================</span>
<span class="go">FAILED test_fib.py::test_raises - RecursionError: maximum recursion depth exceed...</span>
<span class="go">=========================== 1 failed, 2 passed in 1.18s ===========================</span>
</pre></div>
</div>
<p>Notice how informative the output of pytest is compared to our homegrown test suite. <code class="docutils literal notranslate"><span class="pre">pytest</span></code> informs us that two of our tests passed - <code class="docutils literal notranslate"><span class="pre">test_typical</span></code> and <code class="docutils literal notranslate"><span class="pre">test_edge_case</span></code> - while the last one failed. Calling our <code class="docutils literal notranslate"><span class="pre">fib</span></code> function with a negative argument or a non-integer argument will make the function call itself recursively with negative numbers - it never stops! Hence, Python eventually will generate a <code class="docutils literal notranslate"><span class="pre">RecursionError</span></code>. However, our tests are expecting a <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code> instead! Our test correctly detected that the code has this odd behavior. We can fix it up like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fib</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;fib(x) only defined on non-negative integers.&#39;</span><span class="p">)</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">fib_inner</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">cache</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">fib_inner</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib_inner</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">return</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">fib_inner</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can run tests again.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pytest test_fib.py
<span class="go">=============================== test session starts ===============================</span>
<span class="go">platform linux -- Python 3.8.8, pytest-6.2.4, py-1.10.0, pluggy-0.13.1</span>
<span class="go">rootdir: /home/pmin/Documents/codebook</span>
<span class="go">plugins: anyio-3.1.0</span>
<span class="go">collected 3 items</span>

<span class="go">test_fib.py ...                                                             [100%]</span>

<span class="go">================================ 3 passed in 0.02s ================================</span>
</pre></div>
</div>
<p>They pass!</p>
</div>
</div>
<div class="section" id="testing-non-pure-functions-and-classes">
<h2>Testing non-pure functions and classes<a class="headerlink" href="#testing-non-pure-functions-and-classes" title="Permalink to this headline">¶</a></h2>
<p>I claimed earlier that <em>pure functions</em> are the easiest to test. Let’s see what we need to do to test non-pure functions. For a <em>nondeterministic</em> function, you can usually give the random seed or random variables needed by the function as arguments, turning the nondeterministic function into a deterministic one. For a <em>stateful</em> function, we need to additionally test that:</p>
<ul class="simple">
<li><p><em>Postconditions are met</em>, that is, the internal state of the function or object is changed in the expected way by the code</p></li>
</ul>
<p>Classes are stateful, so we’ll need to inspect their state after calling methods on them to make sure they work as expected. For example, consider this Chronometer class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Chronometer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">t0</span>
</pre></div>
</div>
</div>
</div>
<p>We might want to check that the <code class="docutils literal notranslate"><span class="pre">t0</span></code> variable is indeed set by the <code class="docutils literal notranslate"><span class="pre">start</span></code> method.</p>
<p>For a function with <em>I/O side effects</em>, we’ll need to do a little extra work to verify that it works. We might need to create mock files to check whether inputs are read properly and outputs are as expected. <code class="docutils literal notranslate"><span class="pre">io.StringIO</span></code> and the <code class="docutils literal notranslate"><span class="pre">tempfile</span></code> module can help you create these mock objects. For instance, suppose we have a function <code class="docutils literal notranslate"><span class="pre">file_to_upper</span></code> that takes in an input and an output filename, and turns every letter into an uppercase:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">file_to_upper</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
    <span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Writing a test for this is a little tortured:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">test_upper</span><span class="p">():</span>
    <span class="n">in_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">out_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">in_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;test123</span><span class="se">\n</span><span class="s2">thetest&quot;</span><span class="p">)</span>
    <span class="n">in_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">file_to_upper</span><span class="p">(</span><span class="n">in_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">out_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;TEST123</span><span class="se">\n</span><span class="s2">THETEST&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">in_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">out_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With remote calls and persistent storage, testing can rapidly become quite complex.</p>
</div>
<div class="section" id="a-hierarchy-of-tests">
<h2>A hierarchy of tests<a class="headerlink" href="#a-hierarchy-of-tests" title="Permalink to this headline">¶</a></h2>
<p>We’ve been focused so far on <em>unit tests</em>. However, there are many different kinds of tests that people use.</p>
<ul class="simple">
<li><p><em>Static tests</em>: your editor parses and runs your code as you write it to figure out if it will crash</p></li>
<li><p><em>Inline asserts</em>: test whether intermediate computations are as expected</p></li>
<li><p><em>Unit tests</em>: test whether one function or unit of code works as expected</p></li>
<li><p><em>Docstring tests</em>: unit tests embedded in docstrings</p></li>
<li><p><em>Integration tests</em>: test whether multiple functions work correctly together</p></li>
<li><p><em>Smoke tests</em>: test whether a large piece of code crashes at an intermediate stage</p></li>
<li><p><em>Regression tests</em>: tests whether your code is producing the same outputs that it used to in previous versions</p></li>
<li><p><em>End-to-end tests</em>: literally a robot clicking buttons to figure out if your application works as expected</p></li>
</ul>
<p>The point is not to overwhelm you with the possibilities, but to give you a glossary of testing so you know what to look for when you’re ready to dig deeper.</p>
</div>
<div class="section" id="write-lots-of-tiny-unit-tests">
<h2>Write lots of tiny unit tests<a class="headerlink" href="#write-lots-of-tiny-unit-tests" title="Permalink to this headline">¶</a></h2>
<p>My proposal to you is modest:</p>
<ol class="simple">
<li><p>Isolate numeric code.</p></li>
<li><p>Make numeric functions pure if practical.</p></li>
<li><p>Write tests for the numeric code</p></li>
<li><p>Write tests for the critical IO code</p></li>
</ol>
<p>You’re going to get a lot of bang for your buck by writing unit tests - inline asserts and regression tests are also high payoff-to-effort. Aim for each unit test to run in 1 ms. The faster each test runs, the better for your working memory. More than 5 seconds and you’ll be tempted to check your phone.</p>
<p>What do you think is the ideal ratio of test code to real code?</p>
<details class="sphinx-bs dropdown card mb-3">
<summary class="summary-title card-header">
⚠️ Spoilers<div class="summary-down docutils">
<svg version="1.1" width="24" height="24" class="octicon octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="summary-up docutils">
<svg version="1.1" width="24" height="24" class="octicon octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="summary-content card-body docutils">
<p class="card-text">There’s no ideal number per say, but 1:1 to 3:1 is a commonly quoted range for library code. For one-off code, you can usually get away with less test coverage. For more down-to-earth applications, 80% test coverage is a common target. <a class="reference external" href="https://coverage.readthedocs.io/en/coverage-5.3.1/">You can use the <code class="docutils literal notranslate"><span class="pre">Coverage.py</span></code> package to figure out your test coverage</a>.</p>
</div>
</details></div>
<div class="section" id="now-you-re-playing-with-power">
<h2>Now you’re playing with power<a class="headerlink" href="#now-you-re-playing-with-power" title="Permalink to this headline">¶</a></h2>
<p>Testing is the key to refactor with confidence. Let’s say that your code looks ugly, and you feel like it’s time to refactor.</p>
<ol class="simple">
<li><p>Lock in the current behavior of your code with regression tests</p></li>
<li><p>Check that the tests pass</p></li>
<li><p>Rewrite the code to be tidy</p></li>
<li><p>Correct the code</p></li>
<li><p>Iterate until tests pass again</p></li>
</ol>
<p>You can call <code class="docutils literal notranslate"><span class="pre">pytest</span></code> with a specific filename to run one test suite. For a larger refactor, you can run all the tests in the current directory with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pytest .
</pre></div>
</div>
<p>If you want, you can even integrate this workflow into github by running tests every time you push a commit! This is what’s called <em>continuous integration</em>. It’s probably overkill for a small-scale project, but know that it exists.</p>
</div>
<div class="section" id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline">¶</a></h2>
<p>Writing tests is not part of common scientific practice yet, but I think it deserves a higher place in scientific programming education.</p>
<p>Testing allows you to decrease the uncertainty surface of your code. With the right tests, you can convince yourself that parts of your code are <em>correct</em>, and that allows you to concentrate your debugging efforts. Keeping that uncertainty out of your head saves your working memory, and debugging will be faster and more efficient. At the same time, code with tests is less stressful to refactor, so you will be able to continuously improve your code so that it doesn’t slide towards an unmanageable mess of spaghetti.</p>
<p>Testing is not an all-or-none proposition: you can start writing lightweight inline tests in your code today. Find a commented out <code class="docutils literal notranslate"><span class="pre">print</span></code> statement in your code. Can you figure out how to replace it with an <code class="docutils literal notranslate"><span class="pre">assert</span></code>?</p>
<div class="admonition-minute-exercise admonition">
<p class="admonition-title">5-minute exercise</p>
<p>Find a commented out <code class="docutils literal notranslate"><span class="pre">print</span></code> statement in your code and transform it into an <code class="docutils literal notranslate"><span class="pre">assert</span></code>.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "cdminix/tts-for-asr",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./archive"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By <a href='https://cdminix.me'>Christoph Minixhofer</a> <a href='https://twitter.com/cdminix'><img height='24' width='24' src='_images/twitter.svg' alt='Twitter' style='width:24px'></a><br/>
        
            &copy; Copyright 2021.<br/>
          <div class="extra_footer">
            Licensed under CC-BY 4.0, Template based on <a href='https://goodresearch.dev'>goodresearch.dev</a>.
          </div>
      </p>
    </div>
  </footer>
  <!-- Place this tag in your head or just before your close body tag. -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>